# ì¬ê³  ë™ì‹œì„± ì œì–´ ë° Resilience íŒ¨í„´ ìƒì„¸ ê°€ì´ë“œ

## ëª©ì°¨
1. [ë¬¸ì œ ì •ì˜: ì™œ ë™ì‹œì„± ì œì–´ê°€ í•„ìš”í•œê°€?](#1-ë¬¸ì œ-ì •ì˜-ì™œ-ë™ì‹œì„±-ì œì–´ê°€-í•„ìš”í•œê°€)
2. [í•´ê²°ì±… 1: ë¶„ì‚° ë½ (@DistributedLock)](#2-í•´ê²°ì±…-1-ë¶„ì‚°-ë½-distributedlock)
3. [í•´ê²°ì±… 2: ì›ìì  ì¬ê³  ì—…ë°ì´íŠ¸](#3-í•´ê²°ì±…-2-ì›ìì -ì¬ê³ -ì—…ë°ì´íŠ¸)
4. [Redisì—ì„œì˜ ë¶„ì‚° ë½ ë™ì‘ ì›ë¦¬](#4-redisì—ì„œì˜-ë¶„ì‚°-ë½-ë™ì‘-ì›ë¦¬)
5. [Circuit Breaker (ì„œí‚· ë¸Œë ˆì´ì»¤)](#5-circuit-breaker-ì„œí‚·-ë¸Œë ˆì´ì»¤)
   - [5.7 ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ vs ì¸í”„ë¼ ì¥ì• ](#57-ë¹„ì¦ˆë‹ˆìŠ¤-ì˜ˆì™¸-vs-ì¸í”„ë¼-ì¥ì• -ì¤‘ìš”)
6. [Bulkhead (ë²Œí¬í—¤ë“œ)](#6-bulkhead-ë²Œí¬í—¤ë“œ)
7. [Retry (ì¬ì‹œë„)](#7-retry-ì¬ì‹œë„)
8. [ì „ì²´ ë™ì‘ íë¦„](#8-ì „ì²´-ë™ì‘-íë¦„)
9. [ì„¤ì • ê°’ ìƒì„¸ ì„¤ëª…](#9-ì„¤ì •-ê°’-ìƒì„¸-ì„¤ëª…)
   - [9.1 ë¶„ì‚° ë½ ì„¤ì • (waitTime, leaseTime ê¸°ì¤€)](#91-ë¶„ì‚°-ë½-ì„¤ì •)
   - [9.2 ì„œí‚· ë¸Œë ˆì´ì»¤ ì„¤ì •](#92-ì„œí‚·-ë¸Œë ˆì´ì»¤-ì„¤ì •)
10. [í…ŒìŠ¤íŠ¸ ë°©ë²•](#10-í…ŒìŠ¤íŠ¸-ë°©ë²•)

---

## 1. ë¬¸ì œ ì •ì˜: ì™œ ë™ì‹œì„± ì œì–´ê°€ í•„ìš”í•œê°€?

### 1.1 Race Condition (ê²½ìŸ ìƒíƒœ) ë¬¸ì œ

ì¬ê³ ê°€ 1ê°œ ë‚¨ì€ ìƒí’ˆì— ëŒ€í•´ 2ëª…ì´ ë™ì‹œì— ì£¼ë¬¸í•˜ëŠ” ìƒí™©ì„ ê°€ì •í•´ë´…ì‹œë‹¤:

```
ì‹œê°„ìˆœì„œ    ì‚¬ìš©ì A                    ì‚¬ìš©ì B                    ì¬ê³ (DB)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
T1         ì¬ê³  ì¡°íšŒ â†’ 1ê°œ              -                          1
T2         -                           ì¬ê³  ì¡°íšŒ â†’ 1ê°œ              1
T3         1 >= 1 â†’ ì£¼ë¬¸ ê°€ëŠ¥!          -                          1
T4         -                           1 >= 1 â†’ ì£¼ë¬¸ ê°€ëŠ¥!          1
T5         ì¬ê³  ê°ì†Œ (1-1=0)            -                          0
T6         -                           ì¬ê³  ê°ì†Œ (0-1=-1) âš ï¸        -1 âŒ
```

**ê²°ê³¼**: ì¬ê³ ê°€ 1ê°œì¸ë° 2ê°œê°€ íŒ”ë¦¼ â†’ **ê³¼ì‰ íŒë§¤(Overselling)** ë°œìƒ!

### 1.2 Check-Then-Act ì·¨ì•½ì 

```kotlin
// âŒ ìœ„í—˜í•œ ì½”ë“œ (ë™ì‹œì„± ë¬¸ì œ ìˆìŒ)
fun createOrder(productId: Long, quantity: Int) {
    val product = productRepository.findById(productId)

    // Check: ì¬ê³  í™•ì¸
    if (product.stockQuantity >= quantity) {
        // Act: ì¬ê³  ê°ì†Œ
        product.stockQuantity -= quantity  // ì´ ì‚¬ì´ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ!
        productRepository.save(product)
    }
}
```

`Check`ì™€ `Act` ì‚¬ì´ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ë©´ Race Condition ë°œìƒ!

---

## 2. í•´ê²°ì±… 1: ë¶„ì‚° ë½ (@DistributedLock)

### 2.1 ë¶„ì‚° ë½ì´ë€?

ì—¬ëŸ¬ ì„œë²„(ë˜ëŠ” ì¸ìŠ¤í„´ìŠ¤)ì—ì„œ ë™ì‹œì— ê°™ì€ ìì›ì— ì ‘ê·¼í•  ë•Œ, **í•œ ë²ˆì— í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ** í•´ë‹¹ ìì›ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ë³´ì¥í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì…ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Redis (Lock ì €ì¥ì†Œ)                        â”‚
â”‚                                                                 â”‚
â”‚   Key: "order:create:user123"                                   â”‚
â”‚   Value: "server1-thread-abc-uuid"                              â”‚
â”‚   TTL: 30ì´ˆ                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                    â–²                    â–²
         â”‚ Lock íšë“ ì„±ê³µ      â”‚ Lock íšë“ ëŒ€ê¸°      â”‚ Lock íšë“ ì‹¤íŒ¨
         â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Server1 â”‚          â”‚ Server2 â”‚          â”‚ Server3 â”‚
    â”‚ (ì²˜ë¦¬ì¤‘) â”‚          â”‚ (ëŒ€ê¸°ì¤‘) â”‚          â”‚ (ê±°ë¶€ë¨) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 @DistributedLock ì–´ë…¸í…Œì´ì…˜ ë¶„ì„

```kotlin
@Target(AnnotationTarget.FUNCTION)
@Retention(AnnotationRetention.RUNTIME)
annotation class DistributedLock(
    val key: String,           // ë½ í‚¤ (SpEL í‘œí˜„ì‹ ì§€ì›)
    val waitTime: Long = 5,    // ë½ íšë“ ëŒ€ê¸° ì‹œê°„
    val leaseTime: Long = 10,  // ë½ ë³´ìœ  ì‹œê°„ (ìë™ í•´ì œ)
    val timeUnit: TimeUnit = TimeUnit.SECONDS
)
```

### 2.3 ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

```kotlin
@DistributedLock(key = "'order:create:' + #buyerId", waitTime = 5, leaseTime = 30)
fun createOrder(buyerId: Long, req: CreateOrderRequest): OrderResponse {
    // ì´ ë¸”ë¡ì€ ë™ì¼í•œ buyerIdì— ëŒ€í•´ í•œ ë²ˆì— í•˜ë‚˜ë§Œ ì‹¤í–‰ë¨
}
```

**SpEL í‘œí˜„ì‹ í•´ì„**:
- `'order:create:'` â†’ ë¬¸ìì—´ ë¦¬í„°ëŸ´
- `#buyerId` â†’ ë©”ì„œë“œ íŒŒë¼ë¯¸í„° `buyerId`ì˜ ê°’
- ê²°ê³¼: `"order:create:123"` (buyerIdê°€ 123ì¸ ê²½ìš°)

### 2.4 AOP Aspect ë™ì‘ ì›ë¦¬

```kotlin
@Around("@annotation(distributedLock)")
fun around(joinPoint: ProceedingJoinPoint, distributedLock: DistributedLock): Any? {
    // 1. ë½ í‚¤ ìƒì„± (SpEL íŒŒì‹±)
    val lockKey = parseKey(joinPoint, distributedLock.key)
    // ì˜ˆ: "order:create:123"

    // 2. Redissonì„ í†µí•´ Redisì—ì„œ ë½ ê°ì²´ íšë“
    val lock = redissonClient.getLock(lockKey)

    // 3. ë½ íšë“ ì‹œë„
    val acquired = lock.tryLock(
        distributedLock.waitTime,   // 5ì´ˆ ë™ì•ˆ ëŒ€ê¸°
        distributedLock.leaseTime,  // 30ì´ˆ í›„ ìë™ í•´ì œ
        distributedLock.timeUnit
    )

    if (!acquired) {
        // 4a. ë½ íšë“ ì‹¤íŒ¨ â†’ ì˜ˆì™¸ ë°œìƒ
        throw BusinessException(ErrorCode.LOCK_ACQUISITION_FAILED)
    }

    return try {
        // 4b. ë½ íšë“ ì„±ê³µ â†’ ì›ë˜ ë©”ì„œë“œ ì‹¤í–‰
        joinPoint.proceed()
    } finally {
        // 5. ë½ í•´ì œ (í˜„ì¬ ìŠ¤ë ˆë“œê°€ ë³´ìœ í•œ ê²½ìš°ì—ë§Œ)
        if (lock.isHeldByCurrentThread) {
            lock.unlock()
        }
    }
}
```

### 2.5 ì£¼ìš” íŒŒë¼ë¯¸í„° ì„¤ëª…

| íŒŒë¼ë¯¸í„° | ê¸°ë³¸ê°’ | ì„¤ëª… |
|---------|-------|------|
| `waitTime` | 5ì´ˆ | ë½ì„ íšë“í•˜ê¸° ìœ„í•´ ëŒ€ê¸°í•˜ëŠ” ìµœëŒ€ ì‹œê°„. ì´ ì‹œê°„ ë‚´ì— ë½ì„ ëª» ì–»ìœ¼ë©´ ì‹¤íŒ¨ |
| `leaseTime` | 10ì´ˆ | ë½ì„ ë³´ìœ í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ì‹œê°„. ì´ ì‹œê°„ì´ ì§€ë‚˜ë©´ ìë™ìœ¼ë¡œ ë½ í•´ì œ (ë°ë“œë½ ë°©ì§€) |

**leaseTimeì´ ì¤‘ìš”í•œ ì´ìœ **:
```
ì„œë²„ê°€ ë½ì„ íšë“í•œ í›„ í¬ë˜ì‹œë˜ë©´?
â†’ leaseTime í›„ ìë™ í•´ì œë˜ì–´ ë‹¤ë¥¸ ì„œë²„ê°€ ë½ íšë“ ê°€ëŠ¥
â†’ ë°ë“œë½(Deadlock) ë°©ì§€
```

---

## 3. í•´ê²°ì±… 2: ì›ìì  ì¬ê³  ì—…ë°ì´íŠ¸

### 3.1 ì›ìì (Atomic) ì—°ì‚°ì´ë€?

**ì›ìì  ì—°ì‚°**: ì¤‘ê°„ì— ëŠê¸°ì§€ ì•Šê³  **í•œ ë²ˆì— ì™„ë£Œ**ë˜ëŠ” ì—°ì‚°. ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ì¤‘ê°„ì— ë¼ì–´ë“¤ ìˆ˜ ì—†ìŒ.

### 3.2 ê¸°ì¡´ ë°©ì‹ vs ì›ìì  ë°©ì‹

```kotlin
// âŒ ê¸°ì¡´ ë°©ì‹ (ë¹„ì›ìì )
val product = repository.findById(id)
if (product.stockQuantity >= quantity) {
    product.stockQuantity -= quantity
    repository.save(product)
}
// â†’ 3ë²ˆì˜ ì¿¼ë¦¬: SELECT â†’ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œì§ â†’ UPDATE
// â†’ ì¤‘ê°„ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ

// âœ… ì›ìì  ë°©ì‹
val updated = repository.decreaseStockAtomically(id, quantity)
// â†’ 1ë²ˆì˜ ì¿¼ë¦¬ë¡œ ì¡°ê±´ í™•ì¸ + ì—…ë°ì´íŠ¸ ë™ì‹œ ìˆ˜í–‰
// â†’ ì¤‘ê°„ì— ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì´ ë¼ì–´ë“¤ ìˆ˜ ì—†ìŒ
```

### 3.3 ì›ìì  ì¬ê³  ê°ì†Œ ì¿¼ë¦¬ ë¶„ì„

```kotlin
override fun decreaseStockAtomically(productId: Long, quantity: Int): Int {
    val updateCount = entityManager.createQuery("""
        UPDATE Product p
        SET p.stockQuantity = p.stockQuantity - :quantity,
            p.salesCount = p.salesCount + :quantity,
            p.updatedAt = :now
        WHERE p.id = :productId
        AND p.stockQuantity >= :quantity      -- â­ í•µì‹¬: ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸
        AND p.status = :status
    """)
    .setParameter("quantity", quantity)
    .setParameter("productId", productId)
    .setParameter("now", LocalDateTime.now())
    .setParameter("status", ProductStatus.ON_SALE)
    .executeUpdate()

    return updateCount  // ì˜í–¥ë°›ì€ í–‰ ìˆ˜ (0 ë˜ëŠ” 1)
}
```

**í•µì‹¬ í¬ì¸íŠ¸**: `WHERE p.stockQuantity >= :quantity`

ì´ ì¡°ê±´ì´ ìˆì–´ì„œ:
- ì¬ê³ ê°€ ì¶©ë¶„í•˜ë©´ â†’ UPDATE ì„±ê³µ â†’ `updateCount = 1`
- ì¬ê³ ê°€ ë¶€ì¡±í•˜ë©´ â†’ WHERE ì¡°ê±´ ë¶ˆë§Œì¡± â†’ UPDATE ì•ˆ ë¨ â†’ `updateCount = 0`

```kotlin
val updated = productJpaRepository.decreaseStockAtomically(productId, quantity)
if (updated == 0) {
    throw BusinessException(ErrorCode.INSUFFICIENT_STOCK)  // ì¬ê³  ë¶€ì¡±
}
```

### 3.4 ë™ì‹œ ìš”ì²­ ì‹œ ë™ì‘

```
ì‹œê°„ìˆœì„œ    ì‚¬ìš©ì A                              ì‚¬ìš©ì B
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
           ì¬ê³ : 1ê°œ

T1         UPDATE ... WHERE stock >= 1        UPDATE ... WHERE stock >= 1
           â†“                                   â†“
           DB í–‰ ë½(Row Lock) íšë“             DB í–‰ ë½ ëŒ€ê¸°...

T2         stock = 0ìœ¼ë¡œ ë³€ê²½                  (ëŒ€ê¸°ì¤‘)
           COMMIT

T3         updateCount = 1 âœ…                  DB í–‰ ë½ íšë“
                                              stock(0) >= 1? â†’ FALSE
                                              WHERE ì¡°ê±´ ë¶ˆë§Œì¡±

T4                                            updateCount = 0 âŒ
                                              â†’ INSUFFICIENT_STOCK ì˜ˆì™¸
```

**ê²°ê³¼**: ì •í™•íˆ 1ê°œë§Œ íŒë§¤ë¨!

---

## 4. Redisì—ì„œì˜ ë¶„ì‚° ë½ ë™ì‘ ì›ë¦¬

### 4.1 Redissonì˜ ë½ êµ¬í˜„ ë°©ì‹

Redissonì€ Redisì˜ **Lua ìŠ¤í¬ë¦½íŠ¸**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì›ìì ì¸ ë½ ì—°ì‚°ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

#### ë½ íšë“ (tryLock)

```lua
-- Redis Lua ìŠ¤í¬ë¦½íŠ¸ (ë‹¨ìˆœí™”ëœ ë²„ì „)
-- KEYS[1] = ë½ í‚¤ (ì˜ˆ: "order:create:123")
-- ARGV[1] = ë½ ë³´ìœ  ì‹œê°„ (leaseTime)
-- ARGV[2] = ë½ ì†Œìœ ì ID (UUID + threadId)

if (redis.call('exists', KEYS[1]) == 0) then
    -- ë½ì´ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
    redis.call('hset', KEYS[1], ARGV[2], 1)
    redis.call('pexpire', KEYS[1], ARGV[1])
    return nil  -- ë½ íšë“ ì„±ê³µ
end

if (redis.call('hexists', KEYS[1], ARGV[2]) == 1) then
    -- ê°™ì€ ìŠ¤ë ˆë“œê°€ ì´ë¯¸ ë½ì„ ë³´ìœ ì¤‘ì´ë©´ (ì¬ì§„ì… ê°€ëŠ¥)
    redis.call('hincrby', KEYS[1], ARGV[2], 1)
    redis.call('pexpire', KEYS[1], ARGV[1])
    return nil  -- ë½ íšë“ ì„±ê³µ
end

-- ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ë½ì„ ë³´ìœ ì¤‘
return redis.call('pttl', KEYS[1])  -- ë‚¨ì€ TTL ë°˜í™˜
```

#### ë½ í•´ì œ (unlock)

```lua
-- Redis Lua ìŠ¤í¬ë¦½íŠ¸ (ë‹¨ìˆœí™”ëœ ë²„ì „)
if (redis.call('hexists', KEYS[1], ARGV[2]) == 0) then
    -- ë‚´ê°€ ë³´ìœ í•œ ë½ì´ ì•„ë‹ˆë©´ ë¬´ì‹œ
    return nil
end

local counter = redis.call('hincrby', KEYS[1], ARGV[2], -1)
if (counter > 0) then
    -- ì¬ì§„ì… ì¹´ìš´íŠ¸ê°€ ë‚¨ì•„ìˆìœ¼ë©´ TTLë§Œ ê°±ì‹ 
    redis.call('pexpire', KEYS[1], ARGV[1])
    return 0
end

-- ì¹´ìš´íŠ¸ê°€ 0ì´ë©´ ë½ ì‚­ì œ
redis.call('del', KEYS[1])
redis.call('publish', KEYS[2], ARGV[3])  -- ëŒ€ê¸°ì¤‘ì¸ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì•Œë¦¼
return 1
```

### 4.2 Redis ë°ì´í„° êµ¬ì¡°

```
Redis Hash êµ¬ì¡°:

Key: "order:create:123"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Field                     â”‚  Value    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  server1-uuid-thread-1     â”‚  1        â”‚  â† ì¬ì§„ì… ì¹´ìš´íŠ¸
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
TTL: 30000ms
```

### 4.3 ì™œ Redisì¸ê°€?

| íŠ¹ì„± | ì„¤ëª… |
|-----|------|
| **ì‹±ê¸€ ìŠ¤ë ˆë“œ** | Redis ëª…ë ¹ì€ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´ Race Condition ì—†ìŒ |
| **Lua ìŠ¤í¬ë¦½íŠ¸** | ì—¬ëŸ¬ ëª…ë ¹ì„ ì›ìì ìœ¼ë¡œ ì‹¤í–‰ |
| **ê³ ì„±ëŠ¥** | ë©”ëª¨ë¦¬ ê¸°ë°˜ìœ¼ë¡œ ë°€ë¦¬ì´ˆ ë‹¨ìœ„ ì‘ë‹µ |
| **Pub/Sub** | ë½ í•´ì œ ì‹œ ëŒ€ê¸°ì¤‘ì¸ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ |

### 4.4 Pub/Sub ê¸°ë°˜ ëŒ€ê¸°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Server A   â”‚                    â”‚   Server B   â”‚
â”‚  (ë½ ë³´ìœ )    â”‚                    â”‚  (ë½ ëŒ€ê¸°)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                   â”‚
       â”‚ 1. unlock()                       â”‚
       â–¼                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Redis                    â”‚       â”‚
â”‚                                          â”‚       â”‚
â”‚  1. ë½ ì‚­ì œ                               â”‚       â”‚
â”‚  2. PUBLISH "lock:channel" "unlock"  â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â–¶ ì¦‰ì‹œ ì•Œë¦¼ ìˆ˜ì‹ 
â”‚                                          â”‚       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚
                                           3. ë½ ì¬ì‹œë„
                                                  â–¼
                                           4. ë½ íšë“ ì„±ê³µ!
```

**ì¥ì **: Polling ë°©ì‹ë³´ë‹¤ í›¨ì”¬ íš¨ìœ¨ì  (CPU ë‚­ë¹„ ì—†ìŒ)

---

## 5. Circuit Breaker (ì„œí‚· ë¸Œë ˆì´ì»¤)

### 5.1 ì„œí‚· ë¸Œë ˆì´ì»¤ë€?

ì „ê¸° íšŒë¡œì˜ **ì°¨ë‹¨ê¸°(Circuit Breaker)**ì—ì„œ ìœ ë˜í•œ íŒ¨í„´ì…ë‹ˆë‹¤. ê³¼ë¶€í•˜ ì‹œ ì „ê¸°ë¥¼ ì°¨ë‹¨í•˜ë“¯, ì¥ì• ê°€ ë°œìƒí•œ ì„œë¹„ìŠ¤ì— ëŒ€í•œ ìš”ì²­ì„ **ì°¨ë‹¨**í•˜ì—¬ ì‹œìŠ¤í…œ ì „ì²´ì˜ ë¶•ê´´ë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.

### 5.2 ìƒíƒœ ë‹¤ì´ì–´ê·¸ë¨

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                         â”‚
                    â–¼                                         â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
             â”‚    CLOSED    â”‚  â† ì •ìƒ ìƒíƒœ                     â”‚
             â”‚  (ì •ìƒ ìš´ì˜)   â”‚                                 â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
                    â”‚                                         â”‚
        ì‹¤íŒ¨ìœ¨ 50% ì´ˆê³¼                                         â”‚
                    â”‚                                         â”‚
                    â–¼                                         â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
             â”‚     OPEN     â”‚  â† ì°¨ë‹¨ ìƒíƒœ                     â”‚
             â”‚  (ìš”ì²­ ì°¨ë‹¨)   â”‚    ëª¨ë“  ìš”ì²­ ì¦‰ì‹œ ì‹¤íŒ¨           â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
                    â”‚                                         â”‚
        10ì´ˆ ëŒ€ê¸° í›„                                           â”‚
                    â”‚                                         â”‚
                    â–¼                                         â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
             â”‚  HALF-OPEN   â”‚  â† í…ŒìŠ¤íŠ¸ ìƒíƒœ                   â”‚
             â”‚ (ì¼ë¶€ í—ˆìš©)    â”‚    3ê°œ ìš”ì²­ë§Œ í—ˆìš©             â”‚
             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
                    â”‚                                         â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
          â”‚                   â”‚                               â”‚
     ì„±ê³µë¥  ë†’ìŒ           ì‹¤íŒ¨ ì§€ì†                            â”‚
          â”‚                   â”‚                               â”‚
          â–¼                   â–¼                               â”‚
     CLOSEDë¡œ ë³µê·€        OPENìœ¼ë¡œ ë³µê·€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 ì„¤ì • ë¶„ì„

```yaml
resilience4j:
  circuitbreaker:
    instances:
      orderService:
        sliding-window-size: 10           # ìµœê·¼ 10ê°œ ìš”ì²­ì„ ê¸°ì¤€ìœ¼ë¡œ íŒë‹¨
        failure-rate-threshold: 50        # ì‹¤íŒ¨ìœ¨ 50% ì´ˆê³¼ ì‹œ OPEN
        wait-duration-in-open-state: 10s  # OPEN ìƒíƒœì—ì„œ 10ì´ˆ ëŒ€ê¸°
        permitted-number-of-calls-in-half-open-state: 3  # HALF-OPENì—ì„œ 3ê°œë§Œ í—ˆìš©
        slow-call-duration-threshold: 2s  # 2ì´ˆ ì´ìƒ ê±¸ë¦¬ë©´ "ëŠë¦° í˜¸ì¶œ"ë¡œ ê°„ì£¼
        slow-call-rate-threshold: 50      # ëŠë¦° í˜¸ì¶œ 50% ì´ˆê³¼ ì‹œ OPEN
```

### 5.4 ë™ì‘ ì‹œë‚˜ë¦¬ì˜¤

```
ìš”ì²­ ë²ˆí˜¸    ê²°ê³¼      ëˆ„ì  ì‹¤íŒ¨ìœ¨    ìƒíƒœ
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
1           ì„±ê³µ      0%            CLOSED
2           ì„±ê³µ      0%            CLOSED
3           ì‹¤íŒ¨      33%           CLOSED
4           ì‹¤íŒ¨      50%           CLOSED  â† ê²½ê³„ì„ 
5           ì‹¤íŒ¨      60%           CLOSED â†’ OPEN âš¡
6           -         -             OPEN (ì¦‰ì‹œ ê±°ë¶€)
7           -         -             OPEN (ì¦‰ì‹œ ê±°ë¶€)
...         ...       ...           OPEN (10ì´ˆ ëŒ€ê¸°)
            (10ì´ˆ ê²½ê³¼)
16          ì„±ê³µ      -             HALF-OPEN
17          ì„±ê³µ      -             HALF-OPEN
18          ì„±ê³µ      -             HALF-OPEN â†’ CLOSED âœ…
```

### 5.5 Fallback ë©”ì„œë“œ

```kotlin
@CircuitBreaker(name = "orderService", fallbackMethod = "createOrderFallback")
fun createOrder(buyerId: Long, req: CreateOrderRequest): OrderResponse {
    // ì£¼ë¬¸ ìƒì„± ë¡œì§
}

// ì„œí‚·ì´ OPEN ìƒíƒœì´ê±°ë‚˜ ì˜ˆì™¸ ë°œìƒ ì‹œ í˜¸ì¶œë¨
private fun createOrderFallback(buyerId: Long, req: CreateOrderRequest, ex: Throwable): OrderResponse {
    log.error("Circuit breaker fallback triggered. Buyer: $buyerId, Error: ${ex.message}")
    throw BusinessException(ErrorCode.SERVICE_UNAVAILABLE)
}
```

### 5.6 ì™œ ì„œí‚· ë¸Œë ˆì´ì»¤ë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

**ë¬¸ì œ ìƒí™©**: ê²°ì œ ì„œë¹„ìŠ¤ê°€ ë‹¤ìš´ë¨
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ë¬¸ ì„œë¹„ìŠ¤  â”‚â”€â”€â”€â”€â”€â–¶â”‚ ê²°ì œ ì„œë¹„ìŠ¤  â”‚      â”‚   (ë‹¤ìš´!)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ íƒ€ì„ì•„ì›ƒ ëŒ€ê¸° (30ì´ˆ)
       â”‚ íƒ€ì„ì•„ì›ƒ ëŒ€ê¸° (30ì´ˆ)
       â”‚ íƒ€ì„ì•„ì›ƒ ëŒ€ê¸° (30ì´ˆ)
       â–¼
  ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ!
  (ìŠ¤ë ˆë“œ í’€ ê°€ë“ ì°¸)
```

**ì„œí‚· ë¸Œë ˆì´ì»¤ ì ìš© í›„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ì£¼ë¬¸ ì„œë¹„ìŠ¤  â”‚â”€ âœ• â”€â–¶â”‚ ê²°ì œ ì„œë¹„ìŠ¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ ì¦‰ì‹œ ì‹¤íŒ¨ ë°˜í™˜ (Fast Fail)
       â–¼
  "ì„œë¹„ìŠ¤ ì¼ì‹œ ë¶ˆê°€" ì‘ë‹µ
  (ë¦¬ì†ŒìŠ¤ ë³´í˜¸ë¨)
```

**í•µì‹¬ ê°€ì¹˜**:
1. **ì¥ì•  ì „íŒŒ ë°©ì§€**: í•œ ì„œë¹„ìŠ¤ì˜ ì¥ì• ê°€ ì „ì²´ ì‹œìŠ¤í…œìœ¼ë¡œ í¼ì§€ì§€ ì•ŠìŒ
2. **ë¹ ë¥¸ ì‹¤íŒ¨(Fast Fail)**: ë¶ˆí•„ìš”í•œ ëŒ€ê¸° ì‹œê°„ ì œê±°
3. **ìë™ ë³µêµ¬**: ì„œë¹„ìŠ¤ê°€ ë³µêµ¬ë˜ë©´ ìë™ìœ¼ë¡œ ì •ìƒ ìš´ì˜

### 5.7 ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ vs ì¸í”„ë¼ ì¥ì•  (ì¤‘ìš”!)

#### ë¬¸ì œ ìƒí™©

ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ **ì„œë¹„ìŠ¤ ë ˆë²¨**ì—ì„œ ë™ì‘í•˜ë©´, í•œ ìƒí’ˆì˜ ì¬ê³  ì†Œì§„ì´ **ë‹¤ë¥¸ ìƒí’ˆ ì£¼ë¬¸ê¹Œì§€ ì°¨ë‹¨**í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤:

```
ìƒí’ˆ A ì¬ê³  ì†Œì§„ â†’ INSUFFICIENT_STOCK ì—ëŸ¬ ë‹¤ìˆ˜ ë°œìƒ
                â†“
        ì‹¤íŒ¨ìœ¨ 50% ì´ˆê³¼ â†’ Circuit Breaker OPEN
                â†“
    âŒ ìƒí’ˆ B, C ì£¼ë¬¸ë„ ì „ë¶€ ì°¨ë‹¨ë¨! (ì˜ëª»ëœ ë™ì‘)
```

#### í•´ê²°ì±…: ignore-exceptions ì„¤ì •

**ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸**(ì¬ê³  ë¶€ì¡±, ìƒí’ˆ ì—†ìŒ ë“±)ëŠ” ì„œí‚· ë¸Œë ˆì´ì»¤ê°€ **ë¬´ì‹œ**í•˜ë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤:

```yaml
resilience4j:
  circuitbreaker:
    instances:
      orderService:
        sliding-window-size: 10
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        # ğŸ‘‡ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ëŠ” ì‹¤íŒ¨ë¡œ ì¹´ìš´íŠ¸í•˜ì§€ ì•ŠìŒ
        ignore-exceptions:
          - com.example.marketplace.common.BusinessException
```

#### ë™ì‘ ë¹„êµ

**ì„¤ì • ì „ (ë¬¸ì œ ìˆìŒ)**:
```
ìƒí’ˆ A ì¬ê³  ì†Œì§„ (INSUFFICIENT_STOCK)
    â†“ ì‹¤íŒ¨ë¡œ ì¹´ìš´íŠ¸ë¨
Circuit Breaker OPEN
    â†“
ìƒí’ˆ B ì£¼ë¬¸ â†’ 503 Service Unavailable âŒ
```

**ì„¤ì • í›„ (ì •ìƒ ë™ì‘)**:
```
ìƒí’ˆ A ì¬ê³  ì†Œì§„ (INSUFFICIENT_STOCK)
    â†“ ë¬´ì‹œë¨ (ì‹¤íŒ¨ë¡œ ì¹´ìš´íŠ¸ ì•ˆ í•¨)
Circuit Breaker ìƒíƒœ ìœ ì§€ (CLOSED)
    â†“
ìƒí’ˆ B ì£¼ë¬¸ â†’ 200 OK âœ…
```

#### ì˜ˆì™¸ ë¶„ë¥˜ ê°€ì´ë“œ

| ì˜ˆì™¸ ìœ í˜• | ì˜ˆì‹œ | ì„œí‚· ë¸Œë ˆì´ì»¤ ë™ì‘ | ì´ìœ  |
|----------|------|------------------|------|
| **ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸** | ì¬ê³  ë¶€ì¡±, ìƒí’ˆ ì—†ìŒ, ê¶Œí•œ ì—†ìŒ | âœ… **ë¬´ì‹œ** | ì •ìƒì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ íë¦„ |
| **ì¸í”„ë¼ ì¥ì• ** | DB ì—°ê²° ì‹¤íŒ¨, Redis íƒ€ì„ì•„ì›ƒ | âš¡ **ì¹´ìš´íŠ¸** | ì‹œìŠ¤í…œ ì¥ì• , ë³´í˜¸ í•„ìš” |
| **ì™¸ë¶€ API ì¥ì• ** | ê²°ì œ ì„œë¹„ìŠ¤ ë‹¤ìš´, ë°°ì†¡ API ì˜¤ë¥˜ | âš¡ **ì¹´ìš´íŠ¸** | ì™¸ë¶€ ì˜ì¡´ì„± ì¥ì•  |

#### ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼

```
ğŸ“¦ ìƒí’ˆ 3: 30ê°œ â†’ 0ê°œ (ì¬ê³  ì†Œì§„)
    â””â”€ 30ê°œ ì£¼ë¬¸ ì„±ê³µ, ì´í›„ INSUFFICIENT_STOCK

ğŸ“¦ ìƒí’ˆ 4: 200ê°œ â†’ 161ê°œ (ì •ìƒ ì²˜ë¦¬)
    â””â”€ 39ê°œ ì£¼ë¬¸ ì„±ê³µ âœ…
    â””â”€ Circuit Breakerê°€ ì—´ë¦¬ì§€ ì•ŠìŒ!
```

**ê²°ë¡ **: ìƒí’ˆ 3ì˜ ì¬ê³ ê°€ ì†Œì§„ë˜ì–´ë„ ìƒí’ˆ 4 ì£¼ë¬¸ì€ ì •ìƒ ì²˜ë¦¬ë©ë‹ˆë‹¤.

#### record-exceptions vs ignore-exceptions

| ì„¤ì • | ì„¤ëª… |
|-----|------|
| `record-exceptions` | ì‹¤íŒ¨ë¡œ **ì¹´ìš´íŠ¸í• ** ì˜ˆì™¸ ëª©ë¡ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) |
| `ignore-exceptions` | ì‹¤íŒ¨ë¡œ **ì¹´ìš´íŠ¸í•˜ì§€ ì•Šì„** ì˜ˆì™¸ ëª©ë¡ (ë¸”ë™ë¦¬ìŠ¤íŠ¸) |

```yaml
# ë°©ë²• 1: íŠ¹ì • ì˜ˆì™¸ë§Œ ì¹´ìš´íŠ¸ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)
record-exceptions:
  - java.io.IOException
  - java.util.concurrent.TimeoutException

# ë°©ë²• 2: íŠ¹ì • ì˜ˆì™¸ëŠ” ë¬´ì‹œ (ë¸”ë™ë¦¬ìŠ¤íŠ¸) - ê¶Œì¥
ignore-exceptions:
  - com.example.marketplace.common.BusinessException
```

ì¼ë°˜ì ìœ¼ë¡œ `ignore-exceptions`ë¡œ ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ë¥¼ ì œì™¸í•˜ëŠ” ë°©ì‹ì„ ê¶Œì¥í•©ë‹ˆë‹¤.

---

## 6. Bulkhead (ë²Œí¬í—¤ë“œ)

### 6.1 ë²Œí¬í—¤ë“œë€?

**ë²Œí¬í—¤ë“œ(Bulkhead)**ëŠ” ì„ ë°•ì˜ **ê²©ë²½**ì—ì„œ ìœ ë˜í•œ íŒ¨í„´ì…ë‹ˆë‹¤. ì„ ë°•ì—ì„œ í•œ êµ¬ì—­ì— ë¬¼ì´ ì°¨ë„ ê²©ë²½ì´ ë‹¤ë¥¸ êµ¬ì—­ìœ¼ë¡œ ë¬¼ì´ í¼ì§€ëŠ” ê²ƒì„ ë§‰ë“¯ì´, ì‹œìŠ¤í…œì—ì„œ íŠ¹ì • ì„œë¹„ìŠ¤ì˜ ê³¼ë¶€í•˜ê°€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šë„ë¡ **ê²©ë¦¬**í•©ë‹ˆë‹¤.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ì„ ë°• (ì‹œìŠ¤í…œ)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    êµ¬ì—­ A    â”‚    êµ¬ì—­ B    â”‚    êµ¬ì—­ C    â”‚    êµ¬ì—­ D    â”‚ â”‚
â”‚  â”‚  (ì£¼ë¬¸ ì„œë¹„ìŠ¤) â”‚  (ê²°ì œ ì„œë¹„ìŠ¤) â”‚  (ìƒí’ˆ ì„œë¹„ìŠ¤) â”‚  (íšŒì› ì„œë¹„ìŠ¤) â”‚ â”‚
â”‚  â”‚             â”‚             â”‚             â”‚             â”‚ â”‚
â”‚  â”‚  ğŸ’§ ì¹¨ìˆ˜!    â”‚  ğŸ›¡ï¸ ì•ˆì „    â”‚  ğŸ›¡ï¸ ì•ˆì „    â”‚  ğŸ›¡ï¸ ì•ˆì „    â”‚ â”‚
â”‚  â”‚             â”‚             â”‚             â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â–²         â–²         â–²               â”‚
â”‚                       â”‚         â”‚         â”‚               â”‚
â”‚                    ê²©ë²½(Bulkhead)ìœ¼ë¡œ ê²©ë¦¬                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.2 ì„¤ì • ë¶„ì„

```yaml
resilience4j:
  bulkhead:
    instances:
      orderService:
        max-concurrent-calls: 20   # ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ìµœëŒ€ ìš”ì²­ ìˆ˜
        max-wait-duration: 0s      # ëŒ€ê¸° ì—†ì´ ì¦‰ì‹œ ê±°ë¶€
```

### 6.3 ë™ì‘ ì›ë¦¬

```
ë™ì‹œ ìš”ì²­: 25ê°œ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                        â”‚
â”‚    ì²˜ë¦¬ ì¤‘ (20ê°œ)                   ëŒ€ê¸°ì—´ (5ê°œ)          â”‚
â”‚  â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”          â”Œâ”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â”¬â”€â”€â”€â” â”‚
â”‚  â”‚ 1 â”‚ 2 â”‚ 3 â”‚...â”‚20 â”‚          â”‚21 â”‚22 â”‚23 â”‚24 â”‚25 â”‚ â”‚
â”‚  â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜          â””â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”´â”€â”€â”€â”˜ â”‚
â”‚          â”‚                              â”‚             â”‚
â”‚          â–¼                              â–¼             â”‚
â”‚       ì²˜ë¦¬ ì§„í–‰                   max-wait-duration=0s  â”‚
â”‚                                  â†’ ì¦‰ì‹œ BulkheadFullException â”‚
â”‚                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.4 ì™œ ë²Œí¬í—¤ë“œë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

**ë¬¸ì œ ìƒí™©**: ì£¼ë¬¸ ì„œë¹„ìŠ¤ì— ëŒ€ëŸ‰ ìš”ì²­ â†’ ì „ì²´ ìŠ¤ë ˆë“œ í’€ ì ìœ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ê³µìœ  ìŠ¤ë ˆë“œ í’€ (100ê°œ)                  â”‚
â”‚                                                         â”‚
â”‚  ì£¼ë¬¸ ìš”ì²­  ì£¼ë¬¸ ìš”ì²­  ì£¼ë¬¸ ìš”ì²­  ì£¼ë¬¸ ìš”ì²­  ...  ì£¼ë¬¸ ìš”ì²­    â”‚
â”‚  [Thread1] [Thread2] [Thread3] [Thread4]     [Thread100] â”‚
â”‚                                                         â”‚
â”‚  âš ï¸ ìƒí’ˆ ì¡°íšŒ, íšŒì› ì¡°íšŒ ë“± ë‹¤ë¥¸ ìš”ì²­ ì²˜ë¦¬ ë¶ˆê°€!             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë²Œí¬í—¤ë“œ ì ìš© í›„**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ì „ì²´ ìŠ¤ë ˆë“œ í’€ (100ê°œ)                  â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ì£¼ë¬¸ ì„œë¹„ìŠ¤    â”‚ â”‚ ìƒí’ˆ ì„œë¹„ìŠ¤    â”‚ â”‚ íšŒì› ì„œë¹„ìŠ¤    â”‚ â”‚
â”‚  â”‚ (ìµœëŒ€ 20ê°œ)   â”‚ â”‚ (ìµœëŒ€ 30ê°œ)   â”‚ â”‚ (ìµœëŒ€ 50ê°œ)   â”‚ â”‚
â”‚  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚ â”‚
â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆ         â”‚ â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ       â”‚ â”‚
â”‚  â”‚ (20ê°œ ì‚¬ìš©ì¤‘) â”‚ â”‚ (4ê°œ ì‚¬ìš©ì¤‘)  â”‚ â”‚ (6ê°œ ì‚¬ìš©ì¤‘)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  âœ… ì£¼ë¬¸ í­ì£¼í•´ë„ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ëŠ” ì •ìƒ ìš´ì˜!                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Retry (ì¬ì‹œë„)

### 7.1 ì„¤ì • ë¶„ì„

```yaml
resilience4j:
  retry:
    instances:
      orderService:
        max-attempts: 3                # ìµœëŒ€ 3ë²ˆ ì‹œë„
        wait-duration: 500ms           # ì¬ì‹œë„ ê°„ 500ms ëŒ€ê¸°
        retry-exceptions:              # ì´ ì˜ˆì™¸ë“¤ë§Œ ì¬ì‹œë„
          - java.io.IOException
          - java.util.concurrent.TimeoutException
```

### 7.2 ë™ì‘ ì›ë¦¬

```
ì‹œë„ 1                  ì‹œë„ 2                  ì‹œë„ 3
  â”‚                      â”‚                      â”‚
  â–¼                      â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”  ì‹¤íŒ¨        â”Œâ”€â”€â”€â”€â”€â”€â”  ì‹¤íŒ¨        â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ ìš”ì²­  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ì¬ì‹œë„ â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ ì¬ì‹œë„ â”‚
â””â”€â”€â”€â”€â”€â”€â”˜   500ms ëŒ€ê¸°  â””â”€â”€â”€â”€â”€â”€â”˜   500ms ëŒ€ê¸°  â””â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                          ì„±ê³µ ë˜ëŠ” ìµœì¢… ì‹¤íŒ¨
```

### 7.3 ì§€ìˆ˜ ë°±ì˜¤í”„(Exponential Backoff)

ë” ê³ ê¸‰ ì„¤ì •ìœ¼ë¡œ ì¬ì‹œë„ ê°„ê²©ì„ ì ì  ëŠ˜ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
retry:
  instances:
    orderService:
      max-attempts: 5
      wait-duration: 1s
      enable-exponential-backoff: true
      exponential-backoff-multiplier: 2
```

```
ì‹œë„ 1 â†’ ì‹¤íŒ¨ â†’ 1ì´ˆ ëŒ€ê¸°
ì‹œë„ 2 â†’ ì‹¤íŒ¨ â†’ 2ì´ˆ ëŒ€ê¸° (1 Ã— 2)
ì‹œë„ 3 â†’ ì‹¤íŒ¨ â†’ 4ì´ˆ ëŒ€ê¸° (2 Ã— 2)
ì‹œë„ 4 â†’ ì‹¤íŒ¨ â†’ 8ì´ˆ ëŒ€ê¸° (4 Ã— 2)
ì‹œë„ 5 â†’ ì„±ê³µ ë˜ëŠ” ìµœì¢… ì‹¤íŒ¨
```

---

## 8. ì „ì²´ ë™ì‘ íë¦„

### 8.1 ì£¼ë¬¸ ìƒì„± ì‹œ ì „ì²´ í”„ë¡œì„¸ìŠ¤

```
ì‚¬ìš©ì ìš”ì²­: POST /api/v1/orders
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Rate Limiter ì²´í¬                                        â”‚
â”‚     â””â”€ ì´ˆë‹¹ 10ê°œ ì´ˆê³¼? â†’ 429 Too Many Requests               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. Bulkhead ì²´í¬                                            â”‚
â”‚     â””â”€ ë™ì‹œ ìš”ì²­ 20ê°œ ì´ˆê³¼? â†’ 503 Service Unavailable         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Circuit Breaker ì²´í¬                                     â”‚
â”‚     â””â”€ OPEN ìƒíƒœ? â†’ Fallback ì‹¤í–‰ â†’ 503 Service Unavailable  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. Distributed Lock íšë“ (Redis)                            â”‚
â”‚     â””â”€ ë½ í‚¤: "order:create:{buyerId}"                       â”‚
â”‚     â””â”€ 5ì´ˆ ë‚´ íšë“ ì‹¤íŒ¨? â†’ 409 Lock Acquisition Failed        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹¤í–‰                                        â”‚
â”‚     â”œâ”€ êµ¬ë§¤ì ì¡°íšŒ                                           â”‚
â”‚     â”œâ”€ ìƒí’ˆ ì¡°íšŒ                                             â”‚
â”‚     â”œâ”€ ì›ìì  ì¬ê³  ê°ì†Œ (UPDATE ... WHERE stock >= quantity)  â”‚
â”‚     â”‚   â””â”€ updateCount = 0? â†’ 409 Insufficient Stock        â”‚
â”‚     â”œâ”€ ì£¼ë¬¸ ìƒì„±                                             â”‚
â”‚     â””â”€ ì´ë²¤íŠ¸ ë°œí–‰                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. Distributed Lock í•´ì œ (Redis)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. Retry (IOException/TimeoutException ë°œìƒ ì‹œ)             â”‚
â”‚     â””â”€ ìµœëŒ€ 3íšŒ, 500ms ê°„ê²©ìœ¼ë¡œ ì¬ì‹œë„                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â–¼
   ì‘ë‹µ ë°˜í™˜
```

### 8.2 ì–´ë…¸í…Œì´ì…˜ ì‹¤í–‰ ìˆœì„œ

```kotlin
@Transactional                     // 5ï¸âƒ£ íŠ¸ëœì­ì…˜ ì‹œì‘/ì»¤ë°‹
@DistributedLock(...)              // 4ï¸âƒ£ ë¶„ì‚° ë½ íšë“/í•´ì œ
@CircuitBreaker(...)               // 3ï¸âƒ£ ì„œí‚· ìƒíƒœ ì²´í¬
@Bulkhead(...)                     // 2ï¸âƒ£ ë™ì‹œ ìš”ì²­ ìˆ˜ ì²´í¬
@Retry(...)                        // 1ï¸âƒ£ ì¬ì‹œë„ ë˜í•‘
fun createOrder(...) { ... }
```

**ì‹¤í–‰ ìˆœì„œ** (AOP í”„ë¡ì‹œ ì²´ì¸):
```
Retry â†’ Bulkhead â†’ CircuitBreaker â†’ DistributedLock â†’ @Transactional â†’ ì‹¤ì œ ë©”ì„œë“œ
```

---

## 9. ì„¤ì • ê°’ ìƒì„¸ ì„¤ëª…

### 9.1 ë¶„ì‚° ë½ ì„¤ì •

| ì„¤ì • | ê°’ | ì„¤ëª… | ê¶Œì¥ ë²”ìœ„ |
|-----|---|-----|---------|
| `waitTime` | 5ì´ˆ | ë½ íšë“ ëŒ€ê¸° ì‹œê°„ | 1-10ì´ˆ |
| `leaseTime` | 30ì´ˆ | ë½ ìë™ í•´ì œ ì‹œê°„ | ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ Ã— 2-3ë°° |

#### waitTime ì„¤ì • ê¸°ì¤€

**í•µì‹¬ ì›ì¹™**: ì‚¬ìš©ìê°€ í—ˆìš© ê°€ëŠ¥í•œ ìµœëŒ€ ëŒ€ê¸° ì‹œê°„

| ê³ ë ¤ ìš”ì†Œ | ì„¤ëª… |
|----------|------|
| **ì‚¬ìš©ì ê²½í—˜** | 5ì´ˆ ì´ìƒì´ë©´ "ëŠë¦¬ë‹¤"ê³  ëŠë‚Œ |
| **ë™ì‹œ ìš”ì²­ ìˆ˜** | í‰ê·  ì²˜ë¦¬ ì‹œê°„ Ã— ì˜ˆìƒ ëŒ€ê¸° ìˆœë²ˆ |
| **ë¹„ì¦ˆë‹ˆìŠ¤ íŠ¹ì„±** | ê²°ì œì²˜ëŸ¼ ì¤‘ìš”í•œ ì‘ì—…ì€ ê¸¸ê²Œ, ì¡°íšŒì„±ì€ ì§§ê²Œ |

```
ì˜ˆì‹œ) ì£¼ë¬¸ ì²˜ë¦¬
- ì£¼ë¬¸ ì²˜ë¦¬ ì‹œê°„: ì•½ 200ms
- ë™ì‹œ ìš”ì²­: ìµœëŒ€ 10ê°œ ì˜ˆìƒ
- ìµœì•…ì˜ ê²½ìš°: 200ms Ã— 10 = 2ì´ˆ
- ì—¬ìœ  í¬í•¨: 5ì´ˆ ì„¤ì •
```

| ë„ˆë¬´ ì§§ìœ¼ë©´ (1ì´ˆ ë¯¸ë§Œ) | ë„ˆë¬´ ê¸¸ë©´ (30ì´ˆ ì´ìƒ) |
|----------------------|---------------------|
| ë™ì‹œ ìš”ì²­ ì‹œ ë¶ˆí•„ìš”í•œ ì‹¤íŒ¨ ì¦ê°€ | ì‚¬ìš©ìê°€ ì˜¤ë˜ ëŒ€ê¸° |
| "ë½ íšë“ ì‹¤íŒ¨" ì—ëŸ¬ ë¹ˆë²ˆ | UX ì €í•˜, íƒ€ì„ì•„ì›ƒ ë°œìƒ |

#### leaseTime ì„¤ì • ê¸°ì¤€

**í•µì‹¬ ì›ì¹™**: `leaseTime > (ì˜ˆìƒ ìµœëŒ€ ìˆ˜í–‰ ì‹œê°„ Ã— 2~3)`

| ê³ ë ¤ ìš”ì†Œ | ì„¤ëª… |
|----------|------|
| **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì‹œê°„** | ë½ ë‚´ë¶€ì—ì„œ ì‹¤í–‰ë˜ëŠ” ëª¨ë“  ì‘ì—… ì‹œê°„ |
| **ë„¤íŠ¸ì›Œí¬ ì§€ì—°** | DB, ì™¸ë¶€ API í˜¸ì¶œ ì‹œ ì§€ì—° ê°€ëŠ¥ì„± |
| **GC, ì‹œìŠ¤í…œ ì§€ì—°** | JVM GCë‚˜ ì„œë²„ ë¶€í•˜ë¡œ ì¸í•œ ì§€ì—° |
| **ë°ë“œë½ ë°©ì§€** | ì„œë²„ ì¥ì•  ì‹œ ë½ì´ ì˜ì›íˆ ì•ˆ í’€ë¦¬ëŠ” ìƒí™© ë°©ì§€ |

```kotlin
// ì£¼ë¬¸ ìƒì„±ì˜ ê²½ìš°
@DistributedLock(key = "'order:create:' + #buyerId", waitTime = 5, leaseTime = 30)
fun createOrder(...) {
    // 1. ìƒí’ˆ ì¡°íšŒ ë° ê²€ì¦: ~50ms
    // 2. ì¬ê³  ê°ì†Œ (atomic): ~100ms
    // 3. ì£¼ë¬¸ ìƒì„±: ~50ms
    // 4. íŠ¸ëœì­ì…˜ ì»¤ë°‹: ~50ms
    // --------------------------
    // ì •ìƒ ì¼€ì´ìŠ¤ í•©ê³„: ~250ms
    // ìµœì•…ì˜ ì¼€ì´ìŠ¤ (DB ë¶€í•˜, ë„¤íŠ¸ì›Œí¬ ì§€ì—°): ~5-10ì´ˆ
    //
    // leaseTime = 10ì´ˆ Ã— 3 = 30ì´ˆ
}
```

| ë„ˆë¬´ ì§§ìœ¼ë©´ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ë³´ë‹¤ ì§§ê²Œ) | ë„ˆë¬´ ê¸¸ë©´ (5ë¶„ ì´ìƒ) |
|----------------------------------|-------------------|
| âš ï¸ **ë§¤ìš° ìœ„í—˜!** ì‘ì—… ì¤‘ ë½ í•´ì œ | ì„œë²„ ì¥ì•  ì‹œ ë½ì´ ì˜¤ë˜ ìœ ì§€ |
| ë‹¤ë¥¸ ìš”ì²­ì´ ë½ íšë“ â†’ ë™ì‹œì„± ë¬¸ì œ | í•´ë‹¹ ë¦¬ì†ŒìŠ¤ ìš”ì²­ì´ ì˜¤ë˜ ì°¨ë‹¨ |

#### ì‘ì—… ìœ í˜•ë³„ ê¶Œì¥ ê°’

| ì‘ì—… ìœ í˜• | waitTime | leaseTime | ì´ìœ  |
|----------|----------|-----------|------|
| ì¡°íšŒì„± ìºì‹œ ê°±ì‹  | 1-2ì´ˆ | 5ì´ˆ | ë¹ ë¥¸ ì‹¤íŒ¨, ë¹ ë¥¸ ë³µêµ¬ |
| **ì£¼ë¬¸/ê²°ì œ** | **5ì´ˆ** | **30ì´ˆ** | ì¤‘ìš”í•œ ì‘ì—…, ì¶©ë¶„í•œ ì—¬ìœ  |
| ë°°ì¹˜ ì‘ì—… | 10ì´ˆ | 5ë¶„ | ê¸´ ì‘ì—…, ì¬ì‹œë„ ê°€ëŠ¥ |
| ì™¸ë¶€ API ì—°ë™ | 10ì´ˆ | 60ì´ˆ | ë„¤íŠ¸ì›Œí¬ ì§€ì—° ê³ ë ¤ |

> **ğŸ’¡ ì‹¤ë¬´ íŒ**: ê¶Œì¥ ê°€ì´ë“œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •í•œ ë’¤, ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„œ ë©”íŠ¸ë¦­(ë½ íšë“ ì‹¤íŒ¨ìœ¨, í‰ê·  ì²˜ë¦¬ ì‹œê°„)ì„ ëª¨ë‹ˆí„°ë§í•˜ë©´ì„œ ì¡°ì •í•©ë‹ˆë‹¤. íŠ¹íˆ P99 ì‘ë‹µ ì‹œê°„ì„ ê¸°ì¤€ìœ¼ë¡œ leaseTimeì„ ì„¤ì •í•˜ë©´ ëŒ€ë¶€ë¶„ì˜ ìš”ì²­ì„ ì»¤ë²„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### 9.2 ì„œí‚· ë¸Œë ˆì´ì»¤ ì„¤ì •

| ì„¤ì • | ê°’ | ì„¤ëª… |
|-----|---|-----|
| `sliding-window-size` | 10 | ì‹¤íŒ¨ìœ¨ ê³„ì‚° ê¸°ì¤€ ìš”ì²­ ìˆ˜ |
| `failure-rate-threshold` | 50% | OPEN ì „í™˜ ì‹¤íŒ¨ìœ¨ ê¸°ì¤€ |
| `wait-duration-in-open-state` | 10ì´ˆ | OPEN ìƒíƒœ ìœ ì§€ ì‹œê°„ |
| `permitted-number-of-calls-in-half-open-state` | 3 | HALF-OPENì—ì„œ í—ˆìš©í•  ìš”ì²­ ìˆ˜ |
| `slow-call-duration-threshold` | 2ì´ˆ | "ëŠë¦° í˜¸ì¶œ" ê¸°ì¤€ ì‹œê°„ |
| `slow-call-rate-threshold` | 50% | OPEN ì „í™˜ ëŠë¦° í˜¸ì¶œ ë¹„ìœ¨ ê¸°ì¤€ |
| `ignore-exceptions` | BusinessException | ì‹¤íŒ¨ ì¹´ìš´íŠ¸ì—ì„œ ì œì™¸í•  ì˜ˆì™¸ (âš ï¸ ì¤‘ìš”) |

> **ğŸ’¡ ignore-exceptionsê°€ ì¤‘ìš”í•œ ì´ìœ **: ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸(ì¬ê³  ë¶€ì¡±, ì”ì•¡ ë¶€ì¡± ë“±)ë¥¼ ì œì™¸í•˜ì§€ ì•Šìœ¼ë©´ ì •ìƒì ì¸ ë¹„ì¦ˆë‹ˆìŠ¤ ì‹¤íŒ¨ê°€ ì„œí‚· ë¸Œë ˆì´ì»¤ë¥¼ ì—´ì–´ë²„ë ¤ ì „ì²´ ì„œë¹„ìŠ¤ì— ì˜í–¥ì„ ì¤ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [5.7 ë¹„ì¦ˆë‹ˆìŠ¤ ì˜ˆì™¸ vs ì¸í”„ë¼ ì¥ì• ](#57-ë¹„ì¦ˆë‹ˆìŠ¤-ì˜ˆì™¸-vs-ì¸í”„ë¼-ì¥ì• ) ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.

### 9.3 ë²Œí¬í—¤ë“œ ì„¤ì •

| ì„¤ì • | ê°’ | ì„¤ëª… |
|-----|---|-----|
| `max-concurrent-calls` | 20 | ë™ì‹œ ì²˜ë¦¬ ê°€ëŠ¥í•œ ìµœëŒ€ ìš”ì²­ ìˆ˜ |
| `max-wait-duration` | 0ì´ˆ | ëŒ€ê¸°ì—´ ëŒ€ê¸° ì‹œê°„ (0 = ì¦‰ì‹œ ê±°ë¶€) |

### 9.4 ì¬ì‹œë„ ì„¤ì •

| ì„¤ì • | ê°’ | ì„¤ëª… |
|-----|---|-----|
| `max-attempts` | 3 | ìµœëŒ€ ì‹œë„ íšŸìˆ˜ |
| `wait-duration` | 500ms | ì¬ì‹œë„ ê°„ ëŒ€ê¸° ì‹œê°„ |
| `retry-exceptions` | IOException, TimeoutException | ì¬ì‹œë„ ëŒ€ìƒ ì˜ˆì™¸ |

---

## 10. í…ŒìŠ¤íŠ¸ ë°©ë²•

### 10.1 ë™ì‹œì„± í…ŒìŠ¤íŠ¸ (k6)

```javascript
// concurrency-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
    vus: 100,           // ê°€ìƒ ì‚¬ìš©ì 100ëª…
    duration: '10s',    // 10ì´ˆê°„ ì‹¤í–‰
};

export default function() {
    // 1. ë¡œê·¸ì¸í•´ì„œ í† í° íšë“
    let loginRes = http.post('http://localhost:8080/api/v1/auth/login',
        JSON.stringify({
            email: 'buyer@example.com',
            password: 'password123'
        }),
        { headers: { 'Content-Type': 'application/json' } }
    );

    let token = JSON.parse(loginRes.body).data.accessToken;

    // 2. ë™ì¼ ìƒí’ˆì— ë™ì‹œ ì£¼ë¬¸
    let orderRes = http.post('http://localhost:8080/api/v1/orders',
        JSON.stringify({
            orderItems: [{ productId: 1, quantity: 1 }],
            shippingAddress: {
                zipCode: '12345',
                address: 'Test Address',
                addressDetail: 'Apt 101',
                receiverName: 'Test User',
                receiverPhone: '010-1234-5678'
            }
        }),
        { headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        }}
    );

    check(orderRes, {
        'status is 200 or 409': (r) => r.status === 200 || r.status === 409
    });
}
```

ì‹¤í–‰:
```bash
k6 run concurrency-test.js
```

### 10.2 ì„œí‚· ë¸Œë ˆì´ì»¤ í…ŒìŠ¤íŠ¸

```bash
# 1. ì •ìƒ ìš”ì²­ 10ê°œ (CLOSED ìƒíƒœ í™•ì¸)
for i in {1..10}; do
    curl -s http://localhost:8080/api/v1/products | jq '.code'
done

# 2. ì„œí‚· ë¸Œë ˆì´ì»¤ ë©”íŠ¸ë¦­ í™•ì¸
curl http://localhost:8080/actuator/health | jq '.components.circuitBreakers'
```

### 10.3 Redis ë½ í™•ì¸

```bash
# Redis CLI ì ‘ì†
docker exec -it marketplace-redis redis-cli

# ë½ í‚¤ ëª¨ë‹ˆí„°ë§
KEYS order:*

# íŠ¹ì • ë½ ì •ë³´ í™•ì¸
HGETALL "order:create:1"
TTL "order:create:1"
```

---

## ìš”ì•½

| íŒ¨í„´ | ëª©ì  | í•µì‹¬ ê¸°ëŠ¥ |
|-----|-----|----------|
| **Distributed Lock** | ë™ì‹œì„± ì œì–´ | í•œ ë²ˆì— í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤í–‰ |
| **Atomic Update** | ë°ì´í„° ë¬´ê²°ì„± | ì¡°ê±´ë¶€ ì—…ë°ì´íŠ¸ë¡œ Race Condition ë°©ì§€ |
| **Circuit Breaker** | ì¥ì•  ì „íŒŒ ë°©ì§€ | ì‹¤íŒ¨ìœ¨ ë†’ìœ¼ë©´ ìš”ì²­ ì°¨ë‹¨ |
| **Bulkhead** | ë¦¬ì†ŒìŠ¤ ê²©ë¦¬ | ì„œë¹„ìŠ¤ë³„ ë™ì‹œ ìš”ì²­ ìˆ˜ ì œí•œ |
| **Retry** | ì¼ì‹œì  ì˜¤ë¥˜ ë³µêµ¬ | ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ìë™ ì¬ì‹œë„ |

ì´ ëª¨ë“  íŒ¨í„´ì´ í•¨ê»˜ ë™ì‘í•˜ì—¬ **ëŒ€ìš©ëŸ‰ íŠ¸ë˜í”½ì—ì„œë„ ì•ˆì •ì ì¸ ì£¼ë¬¸ ì²˜ë¦¬**ë¥¼ ë³´ì¥í•©ë‹ˆë‹¤.
