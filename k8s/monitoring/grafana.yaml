apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: marketplace
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: marketplace
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: 'default'
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        editable: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: marketplace
data:
  marketplace-dashboard.json: |
    {
      "annotations": {
        "list": []
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "panels": [
        {
          "datasource": { "type": "prometheus", "uid": "PBFA97CFB590B2093" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "reqps"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 0 },
          "id": 1,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "sum(rate(http_server_requests_seconds_count{job=\"marketplace-app\"}[1m])) by (uri)",
              "legendFormat": "{{uri}}",
              "refId": "A"
            }
          ],
          "title": "HTTP Request Rate (per second)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 0 },
          "id": 2,
          "options": { "legend": { "calcs": ["mean", "p95"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{job=\"marketplace-app\"}[5m])) by (le, uri))",
              "legendFormat": "p95 {{uri}}",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus" },
              "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{job=\"marketplace-app\"}[5m])) by (le, uri))",
              "legendFormat": "p50 {{uri}}",
              "refId": "B"
            }
          ],
          "title": "HTTP Response Time (p50, p95)",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 20, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "bytes"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 8 },
          "id": 3,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "jvm_memory_used_bytes{job=\"marketplace-app\", area=\"heap\"}",
              "legendFormat": "{{id}}",
              "refId": "A"
            }
          ],
          "title": "JVM Heap Memory Used",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 8 },
          "id": 4,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "hikaricp_connections_active{job=\"marketplace-app\"}",
              "legendFormat": "Active",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus" },
              "expr": "hikaricp_connections_idle{job=\"marketplace-app\"}",
              "legendFormat": "Idle",
              "refId": "B"
            },
            {
              "datasource": { "type": "prometheus" },
              "expr": "hikaricp_connections_pending{job=\"marketplace-app\"}",
              "legendFormat": "Pending",
              "refId": "C"
            }
          ],
          "title": "HikariCP Connection Pool",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "yellow", "value": 50 }, { "color": "red", "value": 80 }] },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 0, "y": 16 },
          "id": 5,
          "options": { "minVizHeight": 75, "minVizWidth": 75, "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showThresholdLabels": false, "showThresholdMarkers": true, "sizing": "auto" },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "sum(jvm_memory_used_bytes{job=\"marketplace-app\", area=\"heap\"}) / sum(jvm_memory_max_bytes{job=\"marketplace-app\", area=\"heap\"}) * 100",
              "legendFormat": "Heap Usage",
              "refId": "A"
            }
          ],
          "title": "JVM Heap Usage %",
          "type": "gauge"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }, { "color": "red", "value": 1 }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 6, "y": 16 },
          "id": 6,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "sum(rate(http_server_requests_seconds_count{job=\"marketplace-app\", status=~\"5..\"}[5m]))",
              "legendFormat": "5xx Errors",
              "refId": "A"
            }
          ],
          "title": "HTTP 5xx Errors Rate",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 12, "y": 16 },
          "id": 7,
          "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "jvm_threads_live_threads{job=\"marketplace-app\"}",
              "legendFormat": "Live Threads",
              "refId": "A"
            }
          ],
          "title": "JVM Live Threads",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "thresholds" },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": { "h": 4, "w": 6, "x": 18, "y": 16 },
          "id": 8,
          "options": { "colorMode": "value", "graphMode": "none", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "showPercentChange": false, "textMode": "auto", "wideLayout": true },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "process_uptime_seconds{job=\"marketplace-app\"}",
              "legendFormat": "Uptime",
              "refId": "A"
            }
          ],
          "title": "Application Uptime",
          "type": "stat"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 0, "y": 20 },
          "id": 9,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "rate(jvm_gc_pause_seconds_count{job=\"marketplace-app\"}[1m])",
              "legendFormat": "{{action}} - {{cause}}",
              "refId": "A"
            }
          ],
          "title": "JVM GC Pause Count Rate",
          "type": "timeseries"
        },
        {
          "datasource": { "type": "prometheus" },
          "fieldConfig": {
            "defaults": {
              "color": { "mode": "palette-classic" },
              "custom": { "axisBorderShow": false, "axisCenteredZero": false, "axisColorMode": "text", "axisLabel": "", "axisPlacement": "auto", "barAlignment": 0, "drawStyle": "line", "fillOpacity": 10, "gradientMode": "none", "hideFrom": { "legend": false, "tooltip": false, "viz": false }, "insertNulls": false, "lineInterpolation": "smooth", "lineWidth": 2, "pointSize": 5, "scaleDistribution": { "type": "linear" }, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
              "mappings": [],
              "thresholds": { "mode": "absolute", "steps": [{ "color": "green", "value": null }] },
              "unit": "decbytes"
            },
            "overrides": []
          },
          "gridPos": { "h": 8, "w": 12, "x": 12, "y": 20 },
          "id": 10,
          "options": { "legend": { "calcs": ["mean", "max"], "displayMode": "table", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "desc" } },
          "targets": [
            {
              "datasource": { "type": "prometheus" },
              "expr": "rate(jvm_gc_memory_allocated_bytes_total{job=\"marketplace-app\"}[1m])",
              "legendFormat": "Allocated",
              "refId": "A"
            },
            {
              "datasource": { "type": "prometheus" },
              "expr": "rate(jvm_gc_memory_promoted_bytes_total{job=\"marketplace-app\"}[1m])",
              "legendFormat": "Promoted",
              "refId": "B"
            }
          ],
          "title": "JVM GC Memory Allocation Rate",
          "type": "timeseries"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 39,
      "tags": ["marketplace", "spring-boot", "jvm"],
      "templating": { "list": [] },
      "time": { "from": "now-15m", "to": "now" },
      "timepicker": {},
      "timezone": "browser",
      "title": "Marketplace Application",
      "uid": "marketplace-app",
      "version": 1,
      "weekStart": ""
    }
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: grafana-pvc
  namespace: marketplace
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 500Mi
---
apiVersion: v1
kind: Secret
metadata:
  name: grafana-secret
  namespace: marketplace
type: Opaque
stringData:
  GF_SECURITY_ADMIN_USER: admin
  GF_SECURITY_ADMIN_PASSWORD: admin123
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: marketplace
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      securityContext:
        fsGroup: 472
        runAsUser: 472
      containers:
        - name: grafana
          image: grafana/grafana:10.2.0
          ports:
            - containerPort: 3000
          envFrom:
            - secretRef:
                name: grafana-secret
          env:
            - name: GF_USERS_ALLOW_SIGN_UP
              value: "false"
          volumeMounts:
            - name: grafana-storage
              mountPath: /var/lib/grafana
            - name: grafana-datasources
              mountPath: /etc/grafana/provisioning/datasources
            - name: grafana-dashboards-provider
              mountPath: /etc/grafana/provisioning/dashboards
            - name: grafana-dashboards
              mountPath: /var/lib/grafana/dashboards
      volumes:
        - name: grafana-storage
          persistentVolumeClaim:
            claimName: grafana-pvc
        - name: grafana-datasources
          configMap:
            name: grafana-datasources
        - name: grafana-dashboards-provider
          configMap:
            name: grafana-dashboards-provider
        - name: grafana-dashboards
          configMap:
            name: grafana-dashboards
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: marketplace
spec:
  selector:
    app: grafana
  ports:
    - port: 3000
      targetPort: 3000
  type: LoadBalancer
